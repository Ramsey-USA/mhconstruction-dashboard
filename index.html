<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MH Construction Project Dashboard</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-hard-hat"></i>
                <h1>MH Construction Dashboard</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button class="btn btn-secondary" onclick="generateDailyEmails()">
                    <i class="fas fa-envelope"></i> Send Daily Reports
                </button>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span>Project Engineer</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
        <!-- Navigation -->
    <nav class="nav-tabs">
        <button class="nav-tab active" onclick="showTabSafe('dashboard', this)">
            <i class="fas fa-chart-line"></i> Dashboard
        </button>
        <button class="nav-tab" onclick="showTabSafe('projects', this)">
            <i class="fas fa-building"></i> Projects
        </button>
        <button class="nav-tab" onclick="showTabSafe('communications', this)">
            <i class="fas fa-comments"></i> Communications
        </button>
        <button class="nav-tab" onclick="showTabSafe('prospects', this)">
            <i class="fas fa-handshake"></i> Prospects
        </button>
        <button class="nav-tab" onclick="showTabSafe('stakeholders', this)">
            <i class="fas fa-users"></i> Stakeholders
        </button>
        <button class="nav-tab" onclick="showTabSafe('emails', this)">
            <i class="fas fa-envelope"></i> Email Setup
        </button>
        <button class="nav-tab" onclick="showTabSafe('microsoft365', this)">
            <i class="fab fa-microsoft"></i> Microsoft 365
        </button>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Critical Alerts -->
            <section class="alerts-section">
                <h2><i class="fas fa-exclamation-triangle"></i> Critical Alerts</h2>
                <div id="critical-alerts" class="alerts-container">
                    <!-- Alerts will be populated by JavaScript -->
                </div>
            </section>

            <!-- Quick Stats -->
            <section class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-building"></i></div>
                        <div class="stat-info">
                            <h3 id="active-projects">0</h3>
                            <p>Active Projects</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-info">
                            <h3 id="pending-items">0</h3>
                            <p>Pending Items</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
                        <div class="stat-info">
                            <h3 id="overdue-items">0</h3>
                            <p>Overdue Items</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-calendar-week"></i></div>
                        <div class="stat-info">
                            <h3 id="due-this-week">0</h3>
                            <p>Due This Week</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Upcoming Deadlines -->
            <section class="deadlines-section">
                <h2><i class="fas fa-calendar-alt"></i> Upcoming Deadlines</h2>
                <div id="upcoming-deadlines" class="deadlines-container">
                    <!-- Deadlines will be populated by JavaScript -->
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="activity-section">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>
                <div id="recent-activity" class="activity-container">
                    <!-- Activity will be populated by JavaScript -->
                </div>
            </section>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-building"></i> Projects</h2>
                <button class="btn btn-primary" onclick="showAddProjectModal()">
                    <i class="fas fa-plus"></i> Add Project
                </button>
            </div>
            <div id="projects-grid" class="projects-grid">
                <!-- Projects will be populated by JavaScript -->
            </div>
        </div>

        <!-- Communications Tab -->
        <div id="communications" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-comments"></i> Communications</h2>
                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="dashboard.clearCommunicationFilters()" title="Clear all filters">
                        <i class="fas fa-filter"></i> Clear Filters
                    </button>
                    <button class="btn btn-primary" onclick="showAddCommunicationModal()">
                        <i class="fas fa-plus"></i> Add Communication
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">Project</label>
                    <select id="project-filter" onchange="dashboard.filterCommunications()">
                        <option value="">All Projects</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Type</label>
                    <select id="type-filter" onchange="dashboard.filterCommunications()">
                        <option value="">All Types</option>
                        <option value="RFI">üîç RFI</option>
                        <option value="Submittal">üìã Submittal</option>
                        <option value="Change Order">üìù Change Order</option>
                        <option value="Lien Release">‚úÖ Lien Release</option>
                        <option value="General">üí¨ General</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select id="status-filter" onchange="dashboard.filterCommunications()">
                        <option value="">All Status</option>
                        <option value="Pending">‚è≥ Pending</option>
                        <option value="In Progress">üîÑ In Progress</option>
                        <option value="Completed">‚úÖ Completed</option>
                        <option value="Overdue">‚ö†Ô∏è Overdue</option>
                    </select>
                </div>
            </div>

            <div id="communications-list" class="communications-list">
                <!-- Communications will be populated by JavaScript -->
            </div>
        </div>

        <!-- Prospects Tab -->
        <div id="prospects" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-handshake"></i> Prospects</h2>
                <div class="section-actions">
                    <button class="btn btn-info" onclick="syncAllProspectDates()" title="Sync all prospect dates to Outlook Calendar">
                        <i class="fas fa-calendar-plus"></i> Sync All to Calendar
                    </button>
                    <button class="btn btn-primary" onclick="showAddProspectModal()">
                        <i class="fas fa-plus"></i> Add Prospect
                    </button>
                </div>
            </div>
            <div id="prospects-list" class="prospects-list">
                <!-- Prospects will be populated by JavaScript -->
            </div>
        </div>

        <!-- Stakeholders Tab -->
        <div id="stakeholders" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Stakeholders</h2>
                <button class="btn btn-primary" onclick="showAddStakeholderModal()">
                    <i class="fas fa-plus"></i> Add Stakeholder
                </button>
            </div>
            <div id="stakeholders-list" class="stakeholders-list">
                <!-- Stakeholders will be populated by JavaScript -->
            </div>
        </div>

        <!-- Email Setup Tab -->
        <div id="emails" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-mail-bulk"></i> Project Communication Emails</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="showCreateEmailModal()">
                        <i class="fas fa-paper-plane"></i> Create Email
                    </button>
                    <button class="btn btn-secondary" onclick="emailManager.generateDailyEmails()">
                        <i class="fas fa-calendar-day"></i> Generate Daily Emails
                    </button>
                </div>
            </div>
            
            <div class="email-setup">
                <!-- Email Creation Section -->
                <div class="email-creation">
                    <div class="email-filters">
                        <h3>Quick Email Templates</h3>
                        <div class="template-buttons">
                            <button class="btn btn-secondary" onclick="createDailyUpdate()">
                                <i class="fas fa-calendar-day"></i> Daily Update
                            </button>
                            <button class="btn btn-secondary" onclick="createWeeklyReport()">
                                <i class="fas fa-calendar-week"></i> Weekly Report
                            </button>
                            <button class="btn btn-secondary" onclick="createUrgentAlert()">
                                <i class="fas fa-exclamation-triangle"></i> Urgent Items
                            </button>
                            <button class="btn btn-secondary" onclick="createProjectSummary()">
                                <i class="fas fa-chart-line"></i> Project Summary
                            </button>
                        </div>
                    </div>
                </div>

                <div class="email-recipients">
                    <h3>Email Recipients Management</h3>
                    <button class="btn btn-primary" onclick="showAddRecipientModal()">
                        <i class="fas fa-plus"></i> Add Recipient
                    </button>
                    <div id="email-recipients-list" class="recipients-list">
                        <!-- Recipients will be populated by JavaScript -->
                    </div>
                </div>

                <div class="email-preview">
                    <h3>Email Preview</h3>
                    <div class="preview-controls">
                        <select id="preview-recipient" onchange="updateEmailPreview()">
                            <option value="">Select recipient to preview</option>
                        </select>
                        <select id="preview-type" onchange="updateEmailPreview()">
                            <option value="daily">Daily Update</option>
                            <option value="weekly">Weekly Report</option>
                            <option value="urgent">Urgent Items Only</option>
                            <option value="project">Project Summary</option>
                        </select>
                    </div>
                    <div id="email-preview-content" class="email-content">
                        <!-- Preview content will be populated by JavaScript -->
                    </div>
                </div>

                <div class="email-settings">
                    <h3>Email Settings</h3>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="auto-send-enabled"> 
                            Enable automatic sending at 5:00 PM
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            Send time: 
                            <input type="time" id="send-time" value="17:00">
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            Your email signature:
                            <textarea id="email-signature" rows="4" placeholder="Enter your email signature..."></textarea>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Microsoft 365 Integration Tab -->
        <div id="microsoft365" class="tab-content">
            <div class="section-header">
                <h2><i class="fab fa-microsoft"></i> Microsoft 365 Integration</h2>
            </div>
            
            <div class="microsoft365-setup">
                <div class="connection-status">
                    <h3>Connection Status</h3>
                    <div id="microsoft365-status" class="status-card">
                        <div class="status-item">
                            <span class="status-label">Authentication:</span>
                            <span id="auth-status" class="status-value">Checking...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">OneDrive Backup:</span>
                            <span id="onedrive-status" class="status-value">Checking...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Outlook Integration:</span>
                            <span id="outlook-status" class="status-value">Checking...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Auto Backup:</span>
                            <span id="autobackup-status" class="status-value">Checking...</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="testMicrosoft365Connection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                </div>

                <div class="onedrive-backup">
                    <h3>OneDrive Backup</h3>
                    <p>Automatically backup your dashboard data to Microsoft OneDrive for secure cloud storage.</p>
                    
                    <div class="backup-actions">
                        <button class="btn btn-success" onclick="backupToOneDrive()">
                            <i class="fas fa-cloud-upload-alt"></i> Backup Now
                        </button>
                        <button class="btn btn-secondary" onclick="listOneDriveBackups()">
                            <i class="fas fa-list"></i> View Backups
                        </button>
                    </div>
                    
                    <div id="backup-history" class="backup-history">
                        <!-- Backup history will be populated here -->
                    </div>
                </div>

                <div class="outlook-integration">
                    <h3>Outlook Email Integration</h3>
                    <p>Send daily status emails directly through Microsoft Outlook using Graph API.</p>
                    
                    <div class="outlook-features">
                        <div class="feature-item">
                            <i class="fas fa-envelope"></i>
                            <span>Automatic email sending via Outlook</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-calendar"></i>
                            <span>Create calendar events for project deadlines</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-users"></i>
                            <span>Access company address book</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="testOutlookIntegration()">
                        <i class="fas fa-paper-plane"></i> Test Email Integration
                    </button>
                </div>

                <div class="setup-instructions">
                    <h3>Setup Instructions</h3>
                    <div class="instruction-card">
                        <h4>1. Azure App Registration</h4>
                        <p>Register your application in Azure Active Directory to get credentials.</p>
                        <ul>
                            <li>Go to <a href="https://portal.azure.com" target="_blank">Azure Portal</a></li>
                            <li>Navigate to "App registrations" ‚Üí "New registration"</li>
                            <li>Set redirect URI to: <code>http://localhost:3000/auth/callback</code></li>
                            <li>Grant permissions: Mail.Send, Files.ReadWrite, Calendars.ReadWrite</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-card">
                        <h4>2. Environment Configuration</h4>
                        <p>Set these environment variables on your server:</p>
                        <div class="code-block">
                            <code>
                                MICROSOFT_CLIENT_ID=your-app-client-id<br>
                                MICROSOFT_CLIENT_SECRET=your-app-client-secret<br>
                                MICROSOFT_TENANT_ID=your-tenant-id<br>
                                ONEDRIVE_SYNC=true<br>
                                OUTLOOK_INTEGRATION=true<br>
                                AUTO_BACKUP=true<br>
                                BACKUP_INTERVAL_HOURS=24
                            </code>
                        </div>
                    </div>
                    
                    <div class="instruction-card">
                        <h4>3. Company Admin Consent</h4>
                        <p>Your IT administrator needs to grant consent for the application to access company Microsoft 365 resources.</p>
                        <button class="btn btn-info" onclick="openAdminConsentUrl()">
                            <i class="fas fa-shield-alt"></i> Generate Admin Consent URL
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    
    <!-- Add Project Modal -->
    <div id="add-project-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Project</h3>
                <span class="close" onclick="closeModal('add-project-modal')">&times;</span>
            </div>
            <form id="add-project-form">
                <div class="form-group">
                    <label>Project Number:</label>
                    <input type="text" id="project-number" required>
                </div>
                <div class="form-group">
                    <label>Project Name:</label>
                    <input type="text" id="project-name" required>
                </div>
                <div class="form-group">
                    <label>Client:</label>
                    <input type="text" id="project-client" required>
                </div>
                <div class="form-group">
                    <label>Project Manager:</label>
                    <select id="project-manager" required>
                        <option value="">Select PM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Superintendent:</label>
                    <select id="project-superintendent">
                        <option value="">Select Superintendent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date:</label>
                    <input type="date" id="project-start-date" required>
                </div>
                <div class="form-group">
                    <label>End Date:</label>
                    <input type="date" id="project-end-date" required>
                </div>
                <div class="form-group">
                    <label>Contract Value:</label>
                    <input type="number" id="project-value" step="0.01">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-project-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Communication Modal -->
    <div id="add-communication-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Communication</h3>
                <span class="close" onclick="closeModal('add-communication-modal')">&times;</span>
            </div>
            <form id="add-communication-form">
                <div class="form-group">
                    <label>Project:</label>
                    <select id="comm-project" required>
                        <option value="">Select Project</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stakeholder:</label>
                    <select id="comm-stakeholder" required>
                        <option value="">Select Stakeholder</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type:</label>
                    <select id="comm-type" required>
                        <option value="">Select Type</option>
                        <option value="RFI">RFI</option>
                        <option value="Submittal">Submittal</option>
                        <option value="Change Order">Change Order</option>
                        <option value="Lien Release">Lien Release</option>
                        <option value="General">General</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subject/Description:</label>
                    <input type="text" id="comm-subject" required>
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="comm-notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Priority:</label>
                    <select id="comm-priority">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date:</label>
                    <input type="date" id="comm-due-date">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="comm-status">
                        <option value="Pending" selected>Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-communication-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Communication</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Prospect Modal -->
    <div id="add-prospect-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Prospect</h3>
                <span class="close" onclick="closeModal('add-prospect-modal')">&times;</span>
            </div>
            <form id="add-prospect-form">
                <div class="form-group">
                    <label>Prospect Name:</label>
                    <input type="text" id="prospect-name" required>
                </div>
                <div class="form-group">
                    <label>Client:</label>
                    <input type="text" id="prospect-client" required>
                </div>
                <div class="form-group">
                    <label>Estimator:</label>
                    <select id="prospect-estimator">
                        <option value="">Select Estimator</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Walk Date:</label>
                    <input type="date" id="prospect-walk-date">
                </div>
                <div class="form-group">
                    <label>Proposal Due Date:</label>
                    <input type="date" id="prospect-due-date">
                </div>
                <div class="form-group">
                    <label>Estimated Value:</label>
                    <input type="number" id="prospect-value" step="0.01">
                </div>
                <div class="form-group">
                    <label>Win Probability (%):</label>
                    <input type="number" id="prospect-probability" min="0" max="100" value="50">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="prospect-notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-prospect-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Prospect</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Stakeholder Modal -->
    <div id="add-stakeholder-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Stakeholder</h3>
                <span class="close" onclick="closeModal('add-stakeholder-modal')">&times;</span>
            </div>
            <form id="add-stakeholder-form">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="stakeholder-name" required>
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select id="stakeholder-role" required>
                        <option value="">Select Role</option>
                        <option value="Project Manager">Project Manager</option>
                        <option value="Superintendent">Superintendent</option>
                        <option value="Estimator">Estimator</option>
                        <option value="Subcontractor">Subcontractor</option>
                        <option value="Client">Client</option>
                        <option value="Architect">Architect</option>
                        <option value="Engineer">Engineer</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Company:</label>
                    <input type="text" id="stakeholder-company">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="stakeholder-email">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="stakeholder-phone">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="stakeholder-receives-emails">
                        Receives daily status emails
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-stakeholder-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Stakeholder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Email Recipient Modal -->
    <div id="add-recipient-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Email Recipient</h3>
                <span class="close" onclick="closeModal('add-recipient-modal')">&times;</span>
            </div>
            <form id="add-recipient-form">
                <div class="form-group">
                    <label>Stakeholder:</label>
                    <select id="recipient-stakeholder" required>
                        <option value="">Select Stakeholder</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Projects to Include:</label>
                    <div id="recipient-projects" class="checkbox-group">
                        <!-- Projects will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Send Time:</label>
                    <input type="time" id="recipient-send-time" value="17:00">
                </div>
                <div class="form-group">
                    <label>Frequency:</label>
                    <select id="recipient-frequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-recipient-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Recipient</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <div class="footer-logo">
                    <i class="fas fa-hard-hat"></i>
                    <span>MH Construction</span>
                </div>
                <p class="footer-description">
                    Professional construction project management dashboard designed to streamline communications, track progress, and enhance team collaboration.
                </p>
            </div>
            
            <div class="footer-section">
                <h4>Features</h4>
                <ul class="footer-links">
                    <li><i class="fas fa-check"></i> Project Management</li>
                    <li><i class="fas fa-check"></i> Communication Tracking</li>
                    <li><i class="fas fa-check"></i> Stakeholder Management</li>
                    <li><i class="fas fa-check"></i> Automated Reporting</li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h4>Support</h4>
                <ul class="footer-links">
                    <li><a href="#"><i class="fas fa-question-circle"></i> Help Center</a></li>
                    <li><a href="#"><i class="fas fa-book"></i> Documentation</a></li>
                    <li><a href="#"><i class="fas fa-envelope"></i> Contact Support</a></li>
                    <li><a href="#"><i class="fas fa-phone"></i> Call Support</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h4>Integration</h4>
                <div class="integration-status">
                    <div class="integration-item">
                        <i class="fab fa-microsoft"></i>
                        <span>Microsoft 365</span>
                        <span class="status-indicator" id="footer-m365-status">‚óè</span>
                    </div>
                    <div class="integration-item">
                        <i class="fas fa-server"></i>
                        <span>Local Storage</span>
                        <span class="status-indicator connected">‚óè</span>
                    </div>
                    <div class="integration-item">
                        <i class="fas fa-cloud"></i>
                        <span>Cloud Backup</span>
                        <span class="status-indicator" id="footer-backup-status">‚óè</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <p>&copy; 2025 MH Construction Dashboard. Built with modern web technologies for construction professionals.</p>
                <div class="footer-tech">
                    <span>Powered by:</span>
                    <i class="fab fa-html5" title="HTML5"></i>
                    <i class="fab fa-css3-alt" title="CSS3"></i>
                    <i class="fab fa-js-square" title="JavaScript"></i>
                    <i class="fab fa-node-js" title="Node.js"></i>
                </div>
            </div>
        </div>
    </footer>

    <!-- Create Email Modal -->
    <div id="create-email-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Create Project Communication Email</h3>
                <span class="close" onclick="closeModal('create-email-modal')">&times;</span>
            </div>
            <form id="create-email-form">
                <div class="email-creation-grid">
                    <div class="email-settings-section">
                        <h4>Email Settings</h4>
                        <div class="form-group">
                            <label>Email Type:</label>
                            <select id="email-type" onchange="updateEmailType()">
                                <option value="daily">Daily Update</option>
                                <option value="weekly">Weekly Report</option>
                                <option value="urgent">Urgent Items Alert</option>
                                <option value="project">Project Summary</option>
                                <option value="custom">Custom Email</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Range:</label>
                            <select id="date-range">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="this-week">This Week</option>
                                <option value="last-week">Last Week</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div id="custom-date-range" class="form-group" style="display: none;">
                            <label>From:</label>
                            <input type="date" id="date-from">
                            <label>To:</label>
                            <input type="date" id="date-to">
                        </div>
                    </div>

                    <div class="recipients-section">
                        <h4>Select Recipients</h4>
                        <div class="form-group">
                            <label>Projects:</label>
                            <div id="project-selection" class="checkbox-group">
                                <!-- Projects will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Stakeholders:</label>
                            <div id="stakeholder-selection" class="checkbox-group">
                                <!-- Stakeholders will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="content-section">
                        <h4>Email Content</h4>
                        <div class="form-group">
                            <label>Subject Line:</label>
                            <input type="text" id="email-subject" placeholder="Subject will be auto-generated">
                        </div>
                        <div class="form-group">
                            <label>Include:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="include-urgent" checked> Urgent/Overdue Items</label>
                                <label><input type="checkbox" id="include-due-soon" checked> Items Due Soon</label>
                                <label><input type="checkbox" id="include-completed" checked> Recently Completed</label>
                                <label><input type="checkbox" id="include-new" checked> New Communications</label>
                                <label><input type="checkbox" id="include-project-health"> Project Health Summary</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Additional Message:</label>
                            <textarea id="additional-message" rows="3" placeholder="Add any custom message or notes..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="email-preview-section">
                    <h4>Email Preview</h4>
                    <div id="email-composition-preview" class="email-preview-content">
                        <!-- Preview will be populated by JavaScript -->
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-email-modal')">Cancel</button>
                    <button type="button" class="btn btn-secondary" onclick="previewEmail()">
                        <i class="fas fa-eye"></i> Update Preview
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Email
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/data-server.js"></script>
    <script src="js/app.js"></script>
    <script src="js/excel.js"></script>
    <script src="js/emails.js"></script>
    <script>
        console.log('üî• IMMEDIATE SCRIPT EXECUTION TEST - This should appear first');
        
        // Simple direct tab switching function
        function showTabSafe(tabName, clickedElement) {
            console.log('üéØ showTabSafe called with:', tabName, clickedElement);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log(`‚úÖ Tab ${tabName} activated successfully`);
            } else {
                console.error(`‚ùå Tab element with id '${tabName}' not found`);
            }
            
            // Add active class to clicked nav tab
            if (clickedElement) {
                clickedElement.classList.add('active');
                console.log('‚úÖ Active class added to clicked element');
            }
            
            // Load tab-specific content if dashboard is ready
            if (window.dashboard && typeof window.dashboard.loadDashboard === 'function') {
                switch(tabName) {
                    case 'dashboard':
                        window.dashboard.loadDashboard();
                        break;
                    case 'projects':
                        window.dashboard.loadProjects();
                        break;
                    case 'communications':
                        window.dashboard.loadCommunications();
                        break;
                    case 'prospects':
                        window.dashboard.loadProspects();
                        break;
                    case 'stakeholders':
                        window.dashboard.loadStakeholders();
                        break;
                    case 'emails':
                        window.dashboard.loadEmailSetup();
                        break;
                }
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOM loaded, initializing system...');
            
            // Wait for dataManager to be ready with timeout
            if (window.dataManager) {
                console.log('DataManager found, waiting for cache...');
                await new Promise(resolve => {
                    let attempts = 0;
                    const maxAttempts = 30; // 3 seconds max wait
                    
                    const checkReady = () => {
                        attempts++;
                        if (window.dataManager && window.dataManager.cache && Object.keys(window.dataManager.cache).length > 0) {
                            console.log('DataManager cache ready with keys:', Object.keys(window.dataManager.cache));
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.warn('Cache check timeout, proceeding anyway');
                            resolve();
                        } else {
                            console.log(`Waiting for dataManager cache... (attempt ${attempts}/${maxAttempts})`);
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });
            }
            
            // Initialize the dashboard for data loading
            try {
                console.log('üîç Checking if ConstructionDashboard class exists...');
                if (typeof ConstructionDashboard !== 'undefined') {
                    console.log('‚úÖ ConstructionDashboard class found');
                    console.log('Creating ConstructionDashboard instance...');
                    window.dashboard = new ConstructionDashboard();
                    console.log('‚úÖ Dashboard initialized:', window.dashboard);
                    
                    // Load the initial dashboard content
                    console.log('Loading initial dashboard content...');
                    if (typeof window.dashboard.loadDashboard === 'function') {
                        window.dashboard.loadDashboard();
                        console.log('‚úÖ Dashboard content loading initiated');
                    } else {
                        console.error('‚ùå loadDashboard method not found');
                    }
                } else {
                    console.error('‚ùå ConstructionDashboard class not found - loading data manually');
                    // Load data manually
                    window.loadDataManually();
                }
            } catch (error) {
                console.error('‚ùå Error initializing dashboard:', error);
                console.log('Falling back to manual data loading...');
                window.loadDataManually();
            }
        });
        
        // Manual data loading function
        window.loadDataManually = async function() {
            console.log('üìä Loading data manually...');
            
            try {
                // Load dashboard stats
                const statsResponse = await fetch('/api/dashboard/stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    console.log('‚úÖ Dashboard stats loaded:', stats);
                    
                    document.getElementById('active-projects').textContent = stats.activeProjects || '0';
                    document.getElementById('pending-items').textContent = stats.pendingItems || '0';
                    document.getElementById('overdue-items').textContent = stats.overdueItems || '0';
                    document.getElementById('due-this-week').textContent = stats.dueThisWeek || '0';
                }
                
                // Load projects
                const projectsResponse = await fetch('/api/projects');
                if (projectsResponse.ok) {
                    const projects = await projectsResponse.json();
                    console.log('‚úÖ Projects loaded:', projects.length, 'projects');
                    
                    const projectsGrid = document.getElementById('projects-grid');
                    if (projectsGrid && projects.length > 0) {
                        projectsGrid.innerHTML = projects.map(project => `
                            <div class="project-card">
                                <div class="project-header">
                                    <h3>${project.name}</h3>
                                    <span class="project-number">#${project.number}</span>
                                </div>
                                <div class="project-info">
                                    <p><strong>Client:</strong> ${project.client}</p>
                                    <p><strong>Status:</strong> <span class="status-badge status-${project.status}">${project.status.replace('_', ' ')}</span></p>
                                    <p><strong>Value:</strong> $${project.contractValue?.toLocaleString()}</p>
                                    <p><strong>Timeline:</strong> ${new Date(project.startDate).toLocaleDateString()} - ${new Date(project.endDate).toLocaleDateString()}</p>
                                </div>
                                <div class="project-actions">
                                    <button class="btn btn-small btn-secondary" onclick="dashboard.showTab('communications', null); dashboard.filterProjectCommunications('${project.id}')">
                                        <i class="fas fa-comments"></i> Communications
                                    </button>
                                    <button class="btn btn-small btn-primary" onclick="editProject('${project.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                // Load communications
                const commsResponse = await fetch('/api/communications');
                if (commsResponse.ok) {
                    const communications = await commsResponse.json();
                    console.log('‚úÖ Communications loaded:', communications.length, 'items');
                    
                    const commsList = document.getElementById('communications-list');
                    if (commsList && communications.length > 0) {
                        commsList.innerHTML = communications.map(comm => `
                            <div class="communication-item">
                                <div class="comm-header">
                                    <h3>${comm.subject}</h3>
                                    <span class="comm-type">${comm.type}</span>
                                </div>
                                <div class="comm-details">
                                    <div class="comm-meta">
                                        <span class="priority priority-${comm.priority?.toLowerCase()}">${comm.priority} Priority</span>
                                        <span class="status status-${comm.status?.toLowerCase().replace(' ', '-')}">${comm.status}</span>
                                        <span class="due-date">Due: ${new Date(comm.dueDate).toLocaleDateString()}</span>
                                    </div>
                                    <p class="comm-notes">${comm.notes}</p>
                                </div>
                                <div class="comm-actions">
                                    <button class="btn btn-small btn-secondary" onclick="editCommunication('${comm.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-small btn-primary" onclick="markComplete('${comm.id}')">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                // Load prospects
                const prospectsResponse = await fetch('/api/prospects');
                if (prospectsResponse.ok) {
                    const prospects = await prospectsResponse.json();
                    console.log('‚úÖ Prospects loaded:', prospects.length, 'items');
                    
                    const prospectsList = document.getElementById('prospects-list');
                    if (prospectsList && prospects.length > 0) {
                        prospectsList.innerHTML = prospects.map(prospect => `
                            <div class="prospect-card">
                                <div class="prospect-header">
                                    <h3>${prospect.name}</h3>
                                    <span class="prospect-status status-${prospect.status?.toLowerCase().replace(' ', '-')}">${prospect.status}</span>
                                </div>
                                <div class="prospect-info">
                                    <p><strong>Client:</strong> ${prospect.client}</p>
                                    <p><strong>Walk Date:</strong> ${new Date(prospect.walkDate).toLocaleDateString()}</p>
                                    <p><strong>Proposal Due:</strong> ${new Date(prospect.proposalDueDate).toLocaleDateString()}</p>
                                    <p><strong>Est. Value:</strong> $${prospect.estimatedValue?.toLocaleString()}</p>
                                    <p><strong>Probability:</strong> ${prospect.probability}%</p>
                                    <p><strong>Notes:</strong> ${prospect.notes}</p>
                                </div>
                                <div class="prospect-actions">
                                    <button class="btn btn-small btn-secondary" onclick="editProspect('${prospect.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-small btn-success" onclick="convertToProject('${prospect.id}')">
                                        <i class="fas fa-arrow-right"></i> Convert
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                // Load stakeholders
                const stakeholdersResponse = await fetch('/api/stakeholders');
                if (stakeholdersResponse.ok) {
                    const stakeholders = await stakeholdersResponse.json();
                    console.log('‚úÖ Stakeholders loaded:', stakeholders.length, 'items');
                    
                    const stakeholdersList = document.getElementById('stakeholders-list');
                    if (stakeholdersList && stakeholders.length > 0) {
                        stakeholdersList.innerHTML = stakeholders.map(stakeholder => `
                            <div class="stakeholder-card">
                                <div class="stakeholder-info">
                                    <h3>${stakeholder.name}</h3>
                                    <p class="role">${stakeholder.role}</p>
                                    <p class="company">${stakeholder.company}</p>
                                </div>
                                <div class="contact-info">
                                    <p><i class="fas fa-envelope"></i> ${stakeholder.email}</p>
                                    <p><i class="fas fa-phone"></i> ${stakeholder.phone}</p>
                                    <p><i class="fas fa-mail-bulk"></i> ${stakeholder.receivesEmails ? 'Receives Emails' : 'No Emails'}</p>
                                </div>
                                <div class="stakeholder-actions">
                                    <button class="btn btn-small btn-secondary" onclick="editStakeholder('${stakeholder.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-small btn-info" onclick="contactStakeholder('${stakeholder.id}')">
                                        <i class="fas fa-envelope"></i> Contact
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                console.log('‚úÖ Manual data loading completed');
                
            } catch (error) {
                console.error('‚ùå Error loading data manually:', error);
            }
        };
    </script>
</body>
</html>
